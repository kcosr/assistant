# Panel Plugin Migration Guide

This guide describes how to migrate a panel plugin from a prebuilt public bundle
(`public/plugins/<id>/bundle.js`) to a TypeScript source bundle built during the
web-client build. It is written to be reusable for any plugin.

## Table of Contents

- [Goals](#goals)
- [Source files](#source-files)
- [Steps](#steps)
- [Checklist](#checklist)
- [Migration Inventory](#migration-inventory)

## Goals

- Author panel UI in TypeScript under `packages/web-client/src/plugins/<plugin-id>/`.
- Generate the runtime bundle at `packages/web-client/public/plugins/<plugin-id>/bundle.js`.
- Keep the server manifest paths (`web.bundlePath`, `web.stylesPath`) unchanged.

## Source files

- `packages/web-client/src/controllers/panelRegistry.ts`
- `packages/web-client/src/utils/pluginBundleLoader.ts`
- `packages/web-client/package.json`
- `packages/web-client/src/index.ts`

## Steps

1. **Create a TS source entry**
   - Add `packages/web-client/src/plugins/<plugin-id>/index.ts`.
   - Register the panel via `window.ASSISTANT_PANEL_REGISTRY.registerPanel(...)`.
   - Import `PanelHost` from `packages/web-client/src/controllers/panelRegistry` for typing.

2. **Move or add styles**
   - Add `packages/web-client/src/plugins/<plugin-id>/styles.css`.
   - Keep styles small and panel-scoped (prefix classes with the plugin id).

3. **Add build output to the plugin bundle step**
   - Update `packages/web-client/package.json` `bundle:plugins` script to:
     - `esbuild` the new `index.ts` to `public/plugins/<plugin-id>/bundle.js`.
     - Copy `styles.css` to `public/plugins/<plugin-id>/styles.css`.
   - Use a small Node copy script for cross-platform paths.

4. **Keep the server manifest paths**
   - The plugin manifest should continue to point to:
     - `web.bundlePath: '/plugins/<plugin-id>/bundle.js'`
     - `web.stylesPath: '/plugins/<plugin-id>/styles.css'`

5. **Build and verify**
   - Run `npm run build` from the repo root.
   - Enable the plugin and open the panel to confirm it loads.

6. **Remove tracked bundles (if switching to build-only plugins)**
   - Delete `packages/web-client/public/plugins/<plugin-id>/bundle.js` and `styles.css` from git.
   - Add those paths to `.gitignore` to keep them out of commits.
   - Ensure `npm run build` (or `npm run bundle`) runs before serving the web client so bundles exist.

7. **Commit generated bundles (if the repo continues to track them)**
   - If `public/plugins/<plugin-id>/bundle.js` is tracked, commit the updated bundle.
   - If you want bundles untracked, follow step 6 instead.

## Checklist

- [ ] TS source file exists under `src/plugins/<plugin-id>/index.ts`.
- [ ] Styles exist under `src/plugins/<plugin-id>/styles.css`.
- [ ] `bundle:plugins` builds the bundle and copies styles.
- [ ] `public/plugins/<plugin-id>/bundle.js` is generated by build.
- [ ] Plugin loads in the UI via the existing manifest paths.

## Migration Inventory

Pending migrations (bundle-only in `public/plugins/`):

- None (all current panel plugins have TS sources in `src/plugins/`).

Already migrated to TS sources:

- None (panel plugins now live under `packages/plugins`).

Moved to packaged plugin sources:

- `packages/plugins/core/chat/web/index.ts` -> `dist/plugins/chat/public/bundle.js`
- `packages/plugins/official/diff/web/index.ts` -> `dist/plugins/diff/public/bundle.js`
- `packages/plugins/official/files/web/index.ts` -> `dist/plugins/files/public/bundle.js`
- `packages/plugins/official/lists/web/index.ts` -> `dist/plugins/lists/public/bundle.js`
- `packages/plugins/official/notes/web/index.ts` -> `dist/plugins/notes/public/bundle.js`
- `packages/plugins/official/terminal/web/index.ts` -> `dist/plugins/terminal/public/bundle.js`
- `packages/plugins/examples/hello/web/index.ts` -> `dist/plugins/hello/public/bundle.js`
- `packages/plugins/examples/session-info/web/index.ts` -> `dist/plugins/session-info/public/bundle.js`
- `packages/plugins/examples/ws-echo/web/index.ts` -> `dist/plugins/ws-echo/public/bundle.js`
