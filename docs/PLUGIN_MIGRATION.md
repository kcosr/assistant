# Plugin Migration Guide (Operations + Packaged Plugins)

This guide describes how to migrate a legacy plugin or core tool integration to the
current packaged plugin system (manifest + operations + bundled UI).

## Table of Contents

- [Scope](#scope)
- [Source files](#source-files)
- [Target Layout (Repo)](#target-layout-repo)
- [Target Layout (Runtime)](#target-layout-runtime)
- [Migration Checklist](#migration-checklist)
- [Step-by-Step Migration](#step-by-step-migration)
- [Common Cleanup Tasks](#common-cleanup-tasks)
- [Notes](#notes)

## Scope

Use this when moving:

- Legacy tools/http routes into manifest `operations`.
- Panel UIs into `packages/plugins/<group>/<pluginId>/web/`.
- Plugin assets into `dist/plugins/<pluginId>/` (generated by `npm run build:plugins`).

This guide does not cover the older `public/plugins/<id>` bundles; see
`docs/PLUGIN_PANEL_MIGRATION.md` for those legacy panel-only moves.

## Source files

- `packages/agent-server/src/plugins/registry.ts`
- `packages/agent-server/src/plugins/operations.ts`
- `packages/agent-server/src/http/routes/plugins.ts`
- `packages/web-client/src/utils/pluginBundleLoader.ts`
- `packages/assistant-cli/src/pluginRuntime.ts`

## Target Layout (Repo)

```
packages/plugins/<group>/<pluginId>/
  manifest.json
  skill-extra.md           # optional
  server/
    index.ts               # optional (operations handlers)
  web/
    index.ts               # optional (panel bundle)
    styles.css             # optional
  public/                  # optional extra assets
  bin/                     # optional (custom CLI bundle, overrides auto-gen)
```

## Target Layout (Runtime)

```
dist/plugins/<pluginId>/
  manifest.json
  server.js                # optional
  public/
    bundle.js
    styles.css             # optional
    skill.md               # generated
  SKILL.md                 # generated
  bin/
    <pluginId>-cli         # generated if CLI surface enabled
```

## Migration Checklist

- [ ] Move plugin source into `packages/plugins/<group>/<pluginId>/`.
- [ ] Define operations in `manifest.json`.
- [ ] Implement handlers in `server/index.ts` (operations map).
- [ ] Move or create panel bundle in `web/index.ts`.
- [ ] Update client calls to use `/api/plugins/<pluginId>/operations/<op>`.
- [ ] Delete legacy tool/http wiring (core `tools`/`httpRoutes` entries).
- [ ] Ensure `SKILL.md` is generated and updated (optional `skill-extra.md`).
- [ ] Enable plugin in `config.json`.
- [ ] Build and test with `npm run build:plugins` or full `npm run build`.

## Step-by-Step Migration

### 1) Create/Move the plugin package

- Directory: `packages/plugins/<group>/<pluginId>/`
- Add `manifest.json` with `id`, `version`, and optional `panels`, `web`, `server`.

### 2) Migrate server tools to operations

1. Add `operations` entries in `manifest.json`:
   - `id`, `summary`, `inputSchema`, and optional `capabilities`.
2. Set `surfaces` at the manifest level:
   - `{ "tool": true, "http": true, "cli": true }` (enable as needed).
3. Implement `operations` handlers in `server/index.ts`:

```ts
export function createPlugin() {
  return {
    operations: {
      create: async (args, ctx) => ({ ok: true }),
    },
  };
}
```

4. Remove legacy tool definitions (e.g., `tools.ts`) or update them to call
   the new operations if they are still referenced elsewhere.

### 3) Update HTTP callers

Legacy:

```
POST /operations/<op>
```

New:

```
POST /api/plugins/<pluginId>/operations/<op>
```

CLI and tool calls use the same operations endpoints. Session scoping is done
via `x-session-id` or `sessionId` query parameter (CLI passes `--session-id`).

### 4) Migrate panel UI (if applicable)

1. `packages/plugins/<group>/<pluginId>/web/index.ts` registers a panel with:
   `window.ASSISTANT_PANEL_REGISTRY.registerPanel('<panelType>', ...)`
2. Ensure `manifest.json` includes the `panels` entry and `web.bundlePath`.
3. Update panel code to call operations via `/api/plugins/<pluginId>/operations/...`.

### 5) Add skills docs (optional but recommended)

- Add `skill-extra.md` in the plugin root for manual text.
- Build generates:
  - `dist/plugins/<pluginId>/SKILL.md`
  - `dist/skills/<pluginId>/SKILL.md` + `<pluginId>-cli`

### 6) Enable the plugin

`config.json`:

```json
{
  "plugins": {
    "<pluginId>": { "enabled": true }
  }
}
```

### 7) Build and test

```sh
npm run build:plugins
npm run start -w @assistant/agent-server
```

Or the full build if web-client changes are included:

```sh
npm install
npm run build
npm run start -w @assistant/agent-server
```

## Common Cleanup Tasks

- Remove legacy HTTP routes or tool registries tied to the plugin.
- Delete old `public/plugins/<id>/bundle.js` if no longer tracked.
- Verify `SKILL.md` output is correct and included in skills export.
- Update any plugin README to reference operations and panel context.

## Notes

- Tool names are `<pluginId>_<operationId>` with hyphens normalized to underscores.
- CLI commands default to `<operationId>` and run as `<pluginId>-cli <command>`.
- Panel context is published via `host.setContext(getPanelContextKey(panelId), {...})`.
